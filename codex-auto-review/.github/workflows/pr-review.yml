name: PR Review Request

permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  pull_request:
    # opened: Codexが自動でレビューするため不要
    # synchronize: PRのHEADブランチが更新された時に動作
    #              (通常のコミットプッシュ、force push、rebase、merge時に発火)
    types: [synchronize]

jobs:
  request-codex-review:
    runs-on: ubuntu-latest
    # フォークPRではSecretsが利用できないため、内部PRのみ実行
    if: github.event.pull_request.head.repo.full_name == github.repository
    # PAT_TOKENがない場合はステップをスキップ
    env:
      PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

    steps:
      - name: Checkout repository
        if: env.PAT_TOKEN != ''
        uses: actions/checkout@v4

      - name: Codexにレビュー依頼 (config-driven)
        if: env.PAT_TOKEN != ''
        uses: actions/github-script@v7
        with:
          # Personal Access Tokenを使用してCodexをトリガー
          # GITHUB_TOKENではCodexが反応しないため、PATが必要
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const script = require('./.github/scripts/request-codex-review.js');
            await script({ github, context });
